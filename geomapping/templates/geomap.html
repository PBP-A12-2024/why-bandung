{% extends 'base.html' %}
{% load static %}
{% block meta %}
<link rel="stylesheet" type="text/css" href="{% static 'css/bruh.css' %}">
{% endblock meta %}
{% block content %}


<div class="container-fluid">
    <div class="container" >
        <div id="map-container">
            <img src="https://kudapanpagi.wordpress.com/wp-content/uploads/2021/10/vektor-kota-bandung.png" alt="Bandung Map" usemap="#bandung-map" id="bandung-map">
    
            <!-- Define clickable areas -->
            <map name="bandung-map">
                <area target="" alt="Sukasari" title="Sukasari" coords="309,4,312,20,306,32,314,44,323,49,313,78,306,78,292,148,298,158,290,165,284,207,308,241,310,258,293,263,274,256,261,253,153,286,157,265,162,253,166,240,175,216,178,202,179,190,182,181,192,171,210,156,227,143,247,141,258,121,256,113,256,106,266,105,260,85,271,75,282,56,287,37" shape="poly" onclick="showInfo('Sukasari')">
                <area target="" alt="Cidadap" title="Cidadap"  coords="318,42,319,34,331,35,332,41,342,57,347,43,347,54,345,70,341,79,340,94,338,104,334,109,347,118,354,138,362,132,372,117,381,113,384,96,395,85,405,76,415,74,421,64,421,79,427,78,441,84,438,91,441,101,448,106,452,112,457,118,459,110,465,105,465,95,470,87,475,71,481,90,490,98,495,106,494,114,493,125,487,132,478,132,476,140,478,146,468,158,465,165,458,169,447,166,440,166,437,173,427,179,420,180,414,185,407,188,399,194,397,200,400,209,395,211,397,218,390,221,394,227,393,232,385,230,382,240,377,246,376,253,371,258,374,264,366,267,366,273,367,281,367,288,373,290,362,287,358,282,352,291,347,283,334,279,327,276,321,265,313,253,311,243,308,238,300,224,294,217,289,208,290,182,293,164,301,160,304,154,295,147,302,110,306,87,312,80,318,75,320,66,323,60,325,54,325,49,325,43" shape="poly" onclick="showInfo('Cidadap')">
                <area target="" alt="Coblong" title="Coblong"  coords="334,283,339,304,342,335,339,354,339,381,351,382,350,355,363,352,381,363,383,370,399,374,439,375,468,375,470,368,478,355,491,354,494,345,492,333,501,331,511,332,505,318,485,310,485,303,478,299,477,292,465,279,457,275,454,264,456,253,459,245,457,230,452,218,456,210,460,198,460,191,468,182,473,177,480,178,484,163,478,160,470,164,458,170,441,168,428,180,420,181,401,196,403,209,398,212,400,218,394,221,397,228,394,234,385,232,383,240,378,247,377,254,373,259,376,265,368,270,369,285,374,288,369,292,362,289,359,285,354,292,348,290,344,284" shape="poly" onclick="showInfo('Coblong')">
                <area target="" alt="Sukajadi" title="Sukajadi"  coords="184,325,168,301,161,297,157,287,260,255,292,264,309,260,317,260,325,275,332,282,338,304,340,333,338,352,337,381,302,381,282,364,263,354,241,337,226,333,218,334" shape="poly" onclick="showInfo('Sukajadi')">
                <area target="" alt="Cicendo" title="Cicendo"  coords="64,315,94,308,182,326,216,336,226,335,240,339,260,354,281,366,298,381,303,384,339,383,340,396,344,403,345,409,352,407,354,435,350,442,349,456,355,458,354,467,345,466,298,465,262,463,233,450,128,378,138,362,134,346,129,336,124,330,115,329,113,335,110,343,116,351,109,361,103,363,87,352" shape="poly" onclick="showInfo('Cicendo')">
                <area target="" alt="Bandung Wetan" title="Bandung Wetan"  coords="340,383,351,384,354,375,351,357,363,354,380,363,381,370,397,376,438,377,438,387,484,388,530,461,506,474,500,456,484,441,438,432,409,441,402,438,391,437,390,421,373,417,371,425,355,422,354,405,345,405,341,396" shape="poly" onclick="showInfo('Bandung Wetan')">
                <area target="" alt="Cibeunying Kaler" title="Cibeunying Kaler"  coords="440,385,441,378,468,377,472,370,479,357,491,356,495,349,494,335,512,334,509,319,487,309,486,302,480,298,479,291,467,279,459,274,456,264,457,255,461,247,459,230,454,219,461,200,461,192,474,178,484,181,489,206,507,209,512,215,506,217,511,225,505,228,510,241,502,264,510,276,525,280,529,288,525,300,522,309,522,316,529,318,531,309,539,311,544,296,553,303,563,326,576,335,576,341,580,349,588,352,586,379,532,365,529,380,535,392,522,398,506,419,486,386" shape="poly" onclick="showInfo('Cibeunying Kaler')">
                <area target="" alt="Cibeunying Kidul" title="Cibeunying Kidul"  coords="533,459,507,421,524,400,538,393,532,379,533,368,587,381,590,351,581,347,579,341,588,339,601,310,610,312,600,326,607,332,614,329,621,333,620,340,653,349,667,346,698,294,708,282,719,292,714,298,714,305,711,310,698,313,693,318,690,332,687,343,678,345,671,354,666,369,666,375,671,381,672,391,657,391,652,396" shape="poly" onclick="showInfo('Cibeunying Kidul')">
                <area target="" alt="Sumur Bandung" title="Sumur Bandung"  coords="352,503,356,456,350,454,355,436,356,424,371,428,374,420,388,423,389,437,407,443,438,433,482,442,498,457,504,475,433,513" shape="poly" onclick="showInfo('Sumur Bandung')">
                <area target="" alt="Andir" title="Andir"  coords="349,504,354,468,262,465,231,452,126,379,136,361,132,345,128,339,124,332,115,330,116,336,111,342,116,350,111,361,104,364,87,353,141,441,158,473,169,482" shape="poly" onclick="showInfo('Andir')">
                <area target="" alt="Bandung Kulon" title="Bandung Kulon"  coords="212,490,170,484,157,476,141,444,136,449,128,454,119,455,117,462,114,481,119,488,116,499,117,525,106,537,104,551,117,559,111,579,80,565,87,547,75,538,75,549,74,560,60,556,48,551,39,541,28,539,24,545,12,541,2,548,93,678,128,701,132,679,126,678,123,650,127,634,133,628,156,585,163,584,190,538,196,539,203,529,208,522,215,522,210,507" shape="poly" onclick="showInfo('Bandung Kulon')">
                <area target="" alt="Babakan Cipray" title="Babakan Cipray"  coords="130,701,134,680,128,676,125,650,130,635,149,604,156,587,165,586,190,540,196,541,209,523,216,523,212,507,214,489,245,493,245,498,239,503,239,516,241,522,231,596,224,600,223,613,225,626,232,632,230,655,258,662,246,681,253,685,258,706,252,719,254,726,255,734,249,734,248,747,243,755,219,750" shape="poly" onclick="showInfo('Babakan Cipray')">
                <area target="" alt="Bojongloa Kaler" title="Bojongloa Kaler"  coords="259,661,232,654,234,633,226,624,226,601,234,598,243,521,241,504,247,500,248,493,284,498,281,504,277,511,284,518,284,529,295,536,296,553,306,559,307,568,298,601" shape="poly" onclick="showInfo('Bojongloa Kaler')">
                <area target="" alt="Bojongloa Kidul" title="Bojongloa Kidul"  coords="308,570,299,602,249,680,254,685,260,703,254,719,257,733,252,736,250,746,245,756,258,757,379,747,375,741,382,734,382,728,390,722,393,711,385,705,383,696,366,684,361,673,355,674,348,669,347,650,341,649,341,639,322,622,322,595,321,586" shape="poly" onclick="showInfo('Bojongloa Kidul')">
                <area target="" alt="Astanaanyar" title="Astanaanyar"  coords="286,498,280,511,286,517,286,528,296,535,299,543,297,552,306,558,308,566,323,586,324,595,324,622,342,639,342,648,347,649,350,668,356,673,362,672,367,683,379,689,384,697,386,705,395,711,389,725,401,725,362,612,363,606,344,605,349,506" shape="poly" onclick="showInfo('Astanaanyar')">
                <area target="" alt="Regol" title="Regol"  coords="351,506,377,509,383,529,389,533,384,544,429,583,434,598,448,604,453,621,455,638,453,647,459,698,441,700,436,706,427,703,422,705,423,716,417,715,413,724,402,723,364,613,365,605,345,603" shape="poly" onclick="showInfo('Regol')">
                <area target="" alt="Lengkong" title="Lengkong"  coords="458,674,455,649,458,639,450,603,436,596,432,583,386,544,390,534,384,527,378,509,433,515,471,496,475,511,472,521,521,536,544,549,536,586,536,605,533,631,535,646,541,663,502,675,479,677" shape="poly" onclick="showInfo('Lengkong')">
                <area target="" alt="Batununggal" title="Batununggal"  coords="473,493,477,512,474,520,522,534,546,547,537,587,538,605,535,631,536,645,543,662,576,651,583,571,589,565,589,557,592,547,584,435" shape="poly" onclick="showInfo('Batununggal')">
                <area target="" alt="Bandung Kidul" title="Bandung Kidul"  coords="380,748,377,742,383,736,387,727,398,728,404,725,414,726,418,718,425,718,424,707,435,708,441,708,442,703,452,703,460,701,459,678,498,679,567,657,563,674,565,683,560,695,563,709,569,712,569,719,576,726,583,728,602,736,625,743,629,752,628,760,628,767,602,769,580,774,558,775,477,763,431,746" shape="poly" onclick="showInfo('Bandung Kidul')">
                <area target="" alt="Cidadap" title="Cidadap"  coords="579,650,586,572,592,565,594,535,587,433,650,400,657,393,688,395,693,401,688,405,691,410,688,415,679,414,670,416,668,427,666,433,660,429,658,424,642,415,642,426,636,426,638,437,643,444,636,457,639,466,639,488,644,496,649,501,657,502,652,508,655,529,674,535,679,545,682,554,678,574,679,581,679,595,674,601,656,596,653,605,649,629" shape="poly" onclick="showInfo('Cidadap')">
                <area target="" alt="Buahbatu" title="Buahbatu"  coords="570,657,652,630,658,598,675,602,681,594,681,576,682,559,726,576,738,597,745,610,711,612,698,678,691,698,701,704,708,702,723,703,759,707,757,752,728,747,701,739,685,733,679,744,682,749,680,756,681,765,688,777,631,768,632,752,628,740,604,735,584,727,571,717,571,709,564,707,562,695,569,682,565,673" shape="poly" onclick="showInfo('Buahbatu')">
                <area target="" alt="Antapani" title="Antapani"  coords="727,573,684,557,683,547,678,533,657,527,654,507,659,502,650,500,641,487,641,466,638,457,644,445,640,437,638,428,644,427,643,417,657,425,659,431,667,435,672,417,680,416,689,417,691,404,697,403,727,407,729,413,729,421,732,427,737,431,740,440,732,449,735,459,733,466,732,473,729,482,723,487,726,495,725,502,738,517,732,522,730,528,729,534,735,537,733,549,734,555,732,560,724,560,723,565" shape="poly" onclick="showInfo('Antapani')">
                <area target="" alt="Rancasari" title="Rancasari"  coords="690,777,683,766,681,756,684,746,685,735,759,755,762,740,760,713,761,704,723,700,704,699,694,698,699,681,705,654,708,642,712,616,803,610,800,666,822,670,823,678,824,690,835,693,838,700,841,711,840,721,844,728,841,735,844,743,842,754,847,757,847,773,844,794,758,786,719,785" shape="poly" onclick="showInfo('Rancasari')">
                <area target="" alt="Gedebaget" title="Gedebaget"  coords="846,794,884,798,916,796,950,786,1021,749,1019,742,1025,737,1021,731,1018,716,1011,718,1005,716,999,705,1003,694,1000,683,1004,676,960,662,965,633,964,626,964,598,904,601,908,605,911,611,917,615,919,623,920,630,927,633,928,643,925,649,816,608,806,609,802,664,824,667,825,680,827,689,836,691,841,699,843,710,841,720,846,728,843,737,846,744,844,752,848,756,849,767" shape="poly" onclick="showInfo('Gedebage')">
                <area target="" alt="Panyileukan" title="Panyileukan"  coords="1005,675,962,660,968,632,966,595,897,601,895,595,889,595,885,577,894,553,904,553,909,536,915,534,913,524,919,508,915,503,925,496,933,484,944,482,951,474,972,494,984,510,991,541,1001,568,1020,575,1023,584,1038,592,1052,588,1049,603,1044,608,1035,610,1022,628,1027,634,1020,653,1008,655,1002,663" shape="poly" onclick="showInfo('Panyileukan')">
                <area target="" alt="Cinambo" title="Cinambo"  coords="926,634,924,646,821,607,828,606,816,579,821,562,840,542,847,534,840,528,848,516,844,506,845,496,855,489,861,495,876,456,905,465,942,467,949,472,942,478,930,480,923,492,915,496,912,502,916,507,914,516,910,523,911,531,906,535,903,549,893,549,882,575,885,594,893,599,895,606,903,604,909,613,914,621,915,629" shape="poly" onclick="showInfo('Cinambo')">
                <area target="" alt="Arcamanik" title="Arcamanik"  coords="748,609,823,605,817,585,812,579,812,568,839,535,834,521,841,512,839,495,852,482,862,486,872,455,853,431,817,417,792,411,766,412,754,407,730,408,734,424,738,430,743,438,742,445,734,450,737,458,735,466,731,486,726,489,728,503,743,517,731,531,737,535,736,556,733,562,725,563,729,572,729,579" shape="poly" onclick="showInfo('Arcamanik')">
                <area target="" alt="Cibiru" title="Cibiru"  coords="984,505,1003,473,1041,454,1049,436,1065,432,1068,417,1041,403,1029,407,1032,397,1042,393,1044,377,1064,377,1072,369,1081,356,1090,362,1103,360,1107,367,1117,371,1129,372,1129,379,1143,379,1151,383,1151,391,1157,395,1145,423,1145,434,1132,428,1118,442,1108,457,1102,457,1095,479,1087,476,1081,484,1077,491,1077,497,1085,500,1079,526,1083,530,1077,538,1078,552,1068,559,1061,579,1054,585,1038,588,1028,585,1024,574,1005,567,995,544" shape="poly" onclick="showInfo('Cibiru')">
                <area target="" alt="Ujung Berung" title="Ujung Berung"  coords="981,500,991,489,991,478,1000,469,1008,467,1022,460,1031,455,1037,447,1042,444,1047,432,1057,431,1063,426,1063,418,1041,408,1028,412,1024,408,1028,393,1019,400,1015,403,1008,398,1010,350,1010,323,1001,319,998,326,975,322,967,333,955,333,952,342,959,352,955,370,938,371,931,388,955,396,950,426,926,432,883,414,883,406,893,404,888,392,867,382,860,372,856,364,848,362,844,388,851,397,850,405,844,421,856,428,873,453,906,463,942,463" shape="poly" onclick="showInfo('Ujung Berung')">
                <area target="" alt="Mandalajati" title="Mandalajati"  coords="840,420,843,410,849,397,840,391,844,362,833,357,828,340,820,336,812,329,808,319,804,325,798,330,795,337,760,333,755,329,733,328,737,307,745,295,741,290,729,301,719,321,711,319,718,295,712,310,697,315,690,341,679,349,672,356,668,373,672,378,674,391,688,392,695,400,731,404,753,404,763,408,772,405,815,410" shape="poly" onclick="showInfo('Mandalajati')">
            </map>
        </div>
    
        <!-- Display results here -->
        <div id="results-container">
            <div id="product-results"></div>
            <button id="back-button" style="display: none;" onclick="goBack()">Back</button>
        </div>
    </div>
</div>


<script>
    let lastLocation = ""; // Store the last selected location globally

    function showInfo(location) {
        lastLocation = location; // Update the last selected location
        fetch(`filter-tokos/?lokasi=${location}`)
            .then(response => response.json())
            .then(data => {
                const resultsDiv = document.getElementById('product-results');
                resultsDiv.innerHTML = "";  // Clear previous results

                if (data.length > 0) {
                    data.forEach(toko => {
                        const tokoElement = document.createElement('div');
                        tokoElement.classList.add('product-item');
                        tokoElement.setAttribute('onclick', `showProducts('${toko.name}')`);
                        tokoElement.innerHTML = `
                            <div class="product-info">
                                <h3>${toko.name}</h3>
                                <p>Location: ${toko.location}</p>
                            </div>
                        `;
                        resultsDiv.appendChild(tokoElement);
                    });
                } else {
                    resultsDiv.innerHTML = "<p>No stores found for this location.</p>";
                }

                document.getElementById('results-container').classList.add('active');
                document.getElementById('map-container').style.width = "50%";
                document.getElementById('back-button').style.display = "none"; // Hide back button on initial results
            })
            .catch(error => console.error('Error fetching stores:', error));
    }

    function showProducts(tokoId) {
        fetch(`filter-products-by-toko/?toko_id=${tokoId}`)
            .then(response => response.json())
            .then(data => {
                const productsDiv = document.getElementById('product-results');
                productsDiv.innerHTML = "";  // Clear previous results

                if (data.length > 0) {
                    data.forEach(product => {
                        const productElement = document.createElement('div');
                        productElement.classList.add('product-item');
                        productElement.setAttribute('onclick', `window.location.href='/product/product_page/${product.id}/'`);
                        productElement.innerHTML = `
                            <div class="product-info">
                                <h3>${product.name}</h3>
                                <p>Description: ${product.description}</p>
                                <p>Price: Rp${product.price}</p>
                            </div>
                        `;
                        productsDiv.appendChild(productElement);
                    });
                } else {
                    productsDiv.innerHTML = "<p>No products found for this store.</p>";
                }

                document.getElementById('back-button').style.display = "block"; // Show back button in products view
            })
            .catch(error => console.error('Error fetching products:', error));
    }

    function goBack() {
        // Go back to store list by re-calling showInfo with last known location
        showInfo(lastLocation);
    }


    // Function to close results container if clicking outside of map areas
    document.addEventListener('click', (event) => {
        const resultsContainer = document.getElementById('results-container');
        const mapContainer = document.getElementById('map-container');
        const clickedArea = event.target.closest('area');
        const clickedInsideResults = event.target.closest('#results-container'); 
        
        if (!clickedArea && !clickedInsideResults && resultsContainer.classList.contains('active')) {
            resultsContainer.classList.remove('active');
            mapContainer.style.width = "100%"; // Return map to full width
        }
    });


    function adjustCoordinates() {
        const img = document.getElementById('bandung-map');
        const originalWidth = 1163; // Original width of your image
        const originalHeight = 800;  // Original height of your image

        const widthRatio = img.clientWidth / originalWidth;
        const heightRatio = img.clientHeight / originalHeight;

        const areas = document.querySelectorAll('area');

        areas.forEach(area => {
            const coords = area.getAttribute('coords').split(',').map(Number);
            const newCoords = coords.map((coord, index) => {
                return index % 2 === 0 ? coord * widthRatio : coord * heightRatio; // Adjust for x and y
            });
            area.setAttribute('coords', newCoords.join(','));
        });
    }

    window.onload = adjustCoordinates; // Call this function once the window has loaded
    window.onresize = adjustCoordinates; // Adjust coordinates on resize

    let scale = 1;
    const maxScale = 3;
    const minScale = 1;
    const scaleStep = 0.1;
    const mapContainer = document.getElementById('map-container');
    const mapImage = document.getElementById('bandung-map');

    // Handle zooming with scroll or trackpad pinch
    mapContainer.addEventListener('wheel', (event) => {
        event.preventDefault();  // Prevent default scrolling
        if (event.deltaY < 0) {
            // Zoom in
            if (scale < maxScale) scale += scaleStep;
        } else {
            // Zoom out
            if (scale > minScale) scale -= scaleStep;
        }
        mapImage.style.transform = `scale(${scale})`;
    });

    // Optionally, center the zoom to where the cursor is
    mapContainer.addEventListener('mousemove', (event) => {
        if (scale > 1) {
            const rect = mapContainer.getBoundingClientRect();
            const offsetX = event.clientX - rect.left;
            const offsetY = event.clientY - rect.top;
            mapImage.style.transformOrigin = `${(offsetX / mapContainer.clientWidth) * 100}% ${(offsetY / mapContainer.clientHeight) * 100}%`;
        }
    });

</script>

{% endblock %}