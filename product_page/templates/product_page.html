{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Page</title>
</head>
<body>
    {% if product %}
        <!-- Product Details Section -->
        <div class="product-details">
            <div class="product-image">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" width="300px">
                {% else %}
                    <p>Gambar tidak tersedia</p>
                {% endif %}
            </div>
        
            <div class="product-info">
                <h1>{{ product.name }}</h1>
                <p>{{ product.description }}</p>
                <p>{{ product.store }}</p>
                <p><strong>Price:</strong> Rp. {{ product.price }}</p>
        
                <h3>Tags:</h3>
                <ul>
                    {% for hashtag in product.hashtags.all %}
                        <li>#{{ hashtag.tag }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        

        <hr>

        <!-- Reviews Section -->
        <div class="reviews">
            <h3>Reviews:</h3>
            <ul>
                {% if reviews %}
                    {% for review in reviews %}
                        <li>
                            <strong>{{ review.user.username }}</strong> rated it {{ review.rating }}/5
                            <p>{{ review.comment }}</p>
                            <p>Posted on {{ review.created_at|date:"F j, Y, g:i a" }}</p>
                        </li>
                    {% endfor %}
                {% else %}
                    <p>No reviews yet. Be the first to review!</p>
                {% endif %}
            </ul>

            <!-- Review Form -->
            {% if user.is_authenticated %}
                <h3>Add Your Review</h3>
                <form id="ajax-review-form" method="post" action="{% url 'main:add_review' product.id %}">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit">Submit Review</button>
                </form>
            {% else %}
               <p><a href="{% url 'main:product_page' %}">Login</a> to leave a review.</p> <!-- bisa di ubah -->
            {% endif %}
        </div>
    {% else %}
        <!-- Display message if no product is found -->
        <p>{{ message }}</p>
    {% endif %}

    <!-- JavaScript for AJAX -->
    <script>
        document.getElementById('ajax-review-form').addEventListener('submit', function(e) {
            e.preventDefault();
            var form = this;
            var xhr = new XMLHttpRequest();
            xhr.open('POST', form.action, true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    alert('Review submitted successfully!');
                    location.reload(); // Optionally reload the page to display the new review
                } else if (xhr.status != 200) {
                    alert('An error occurred. Please try again.');
                }
            };
            var formData = new FormData(form);
            xhr.send(new URLSearchParams(formData).toString());
        });
    </script>

</body>
</html>
